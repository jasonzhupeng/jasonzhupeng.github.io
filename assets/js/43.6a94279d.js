(window.webpackJsonp=window.webpackJsonp||[]).push([[43],{486:function(s,a,t){"use strict";t.r(a);var e=t(2),r=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"使用语句备份、还原、附加、分离数据库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用语句备份、还原、附加、分离数据库"}},[s._v("#")]),s._v(" 使用语句备份、还原、附加、分离数据库")]),s._v(" "),a("p",[s._v("众所周知微软官方客户端工具"),a("code",[s._v("SQL Server Management Studio (SSMS)")]),s._v("是带附加、分离、备份、还原可视化按钮的，傻瓜式操作点击下一步即可...\n但是我们用第三方客户端作为自己的日常开发工具的时候，比如："),a("code",[s._v("Navicat for SQL Server")]),s._v("、"),a("code",[s._v("dbeaver")]),s._v("。是不具备这些可视化按钮的，\n所以这里重点笔记一下如何使用sql语句的方式附加和还原数据库:")]),s._v(" "),a("h3",{attrs:{id:"_1-备份数据库-完整备份"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-备份数据库-完整备份"}},[s._v("#")]),s._v(" 1.备份数据库（完整备份）")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("use")]),s._v(" master\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("backup")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("database")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("TestDb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("disk")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'F:\\LocalDbRepo\\TestDb_'")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("convert")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("varchar")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("getdate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("112")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'.bak'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WITH")]),s._v(" NOFORMAT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" NOINIT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  NAME "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" N"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'TestDb-完整 数据库 备份'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" SKIP"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" NOREWIND"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" NOUNLOAD\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h3",{attrs:{id:"_2-还原备份-bak-文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-还原备份-bak-文件"}},[s._v("#")]),s._v(" 2.还原备份（.bak）文件")]),s._v(" "),a("p",[s._v("如果是通过备份文件新建数据库，则需要先在创建新数据库，再备份")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("br"),a("br"),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("use")]),s._v(" master  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--这里注意要使用master，以免出现待还原库被占用的情况")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("restore")]),s._v(" filelistonly "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("disk")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'F:\\LocalDbRepo\\test_20200609.bak'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 先查询备份文件，数据库逻辑文件名称")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("restore")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("database")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("TestDb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("disk")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'F:\\LocalDbRepo\\test_20200609.bak'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--备份文件的位置")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("with")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--数据文件逻辑名字")]),s._v("\n move "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'test_db'")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'F:\\LocalDbRepo\\sqldb\\TestDb.mdf'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--指定新的数据文件路径")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--日志文件逻辑名字")]),s._v("\n move "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'test_log'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'F:\\LocalDbRepo\\sqldb\\TestDb.ldf'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--指定新的日志文件路径")]),s._v("\nSTATS "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("replace")]),s._v("\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("h3",{attrs:{id:"_3-附加数据库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-附加数据库"}},[s._v("#")]),s._v(" 3.附加数据库")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("use")]),s._v(" master\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("exec")]),s._v(" sp_attach_db "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@dbname")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" N"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'TestDb'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@filename1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" N"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'F:\\LocalDbRepo\\sqldb\\TestDb.mdf'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--逻辑文件路径")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@filename2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" N"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'F:\\LocalDbRepo\\sqldb\\TestDb_log.ldf'")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--日志文件路径")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h3",{attrs:{id:"_4-分离数据库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-分离数据库"}},[s._v("#")]),s._v(" 4.分离数据库")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("use")]),s._v(" master\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("exec")]),s._v(" sp_detach_db "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@dbname")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("N"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'TestDB'")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h2",{attrs:{id:"添加链接服务器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#添加链接服务器"}},[s._v("#")]),s._v(" 添加链接服务器")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--查询已创建的链接服务器")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" sys"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("servers "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" is_linked"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" \n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--创建链接服务器")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXEC")]),s._v(" master"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("dbo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sp_addlinkedserver "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@server")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" N"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'服务器IP'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@srvproduct")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("N"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'SQL Server'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--创建链接服务器登录账户")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXEC")]),s._v(" master"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("dbo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sp_addlinkedsrvlogin "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@rmtsrvname")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" N"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'服务器IP'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@locallogin")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@useself")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" N"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'False'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@rmtuser")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" N"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sa'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@rmtpassword")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" N"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--修改链接服务器名称")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXEC")]),s._v(" master"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("dbo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sp_serveroption "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@server")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("N"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'服务器IP'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@optname")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("N"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'name'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@optvalue")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("N"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'custom name'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--删除链接服务器")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("exec")]),s._v(" sp_dropserver "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'服务器IP'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'droplogins'")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])])])}),[],!1,null,null,null);a.default=r.exports}}]);